name: Traffic Monitor

on:
  schedule:
    - cron: '59 14 * * *' # ë§¤ì¼ ë°¤ 11:59 (KST)
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰

permissions:
  contents: write

jobs:
  update-traffic:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests beautifulsoup4 pandas

      - name: Run Traffic Script
        shell: python
        run: |
          import requests
          from bs4 import BeautifulSoup
          import pandas as pd
          from datetime import datetime
          import os
          import json

          # --- 1. ì„¤ì • ë° ë°ì´í„° ìˆ˜ì§‘ ---
          URL = "http://lunamoth.com/throttle-me"
          CSV_FILE = "traffic_data.csv"
          HTML_FILE = "index.html"

          # ê°€ì§œ í—¤ë” (ì°¨ë‹¨ ë°©ì§€ìš©)
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
          }

          kbytes = 0
          found = False

          try:
              print(f"Connecting to {URL}...")
              response = requests.get(URL, headers=headers, timeout=30)
              response.raise_for_status()
              soup = BeautifulSoup(response.text, 'html.parser')

              rows = soup.find_all('tr')
              for row in rows:
                  if "lunamoth.biz" in row.text:
                      cols = [ele.text.strip() for ele in row.find_all(['td', 'th'])]
                      # lunamoth.biz í–‰ì˜ 6ë²ˆì§¸(index 5) ë°ì´í„°ê°€ KBytes sent
                      if len(cols) > 5:
                          kbytes = int(cols[5])
                          found = True
                          break
              
              if not found:
                  print("Warning: Could not find traffic data using lxml, trying simple text search.")
                  # ë¹„ìƒìš© íŒŒì‹± ë¡œì§ (í˜¹ì‹œë‚˜ í•´ì„œ)
                  if "lunamoth.biz" in response.text:
                      # í…ìŠ¤íŠ¸ êµ¬ì¡°ìƒ ë‹¨ìˆœíˆ ìˆ«ì íŒŒì‹±ì´ ì–´ë µì§€ë§Œ ì—ëŸ¬ ë°©ì§€ìš©
                      pass 

          except Exception as e:
              print(f"Error fetching data: {e}")
              # ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨ì‹œ ê¸°ì¡´ CSVë¼ë„ ì½ì–´ì„œ HTML ê°±ì‹ í•˜ë„ë¡ íŒ¨ìŠ¤
              pass

          # --- 2. CSV ì €ì¥ (ìˆ˜ì§‘ ì„±ê³µ ì‹œì—ë§Œ) ---
          if found:
              now = datetime.now()
              today_str = now.strftime("%Y-%m-%d")
              mbytes = round(kbytes / 1024, 2)

              new_data = {'date': today_str, 'kbytes': kbytes, 'mbytes': mbytes}
              
              if os.path.exists(CSV_FILE):
                  df = pd.read_csv(CSV_FILE)
                  # ì˜¤ëŠ˜ ë‚ ì§œ ì¤‘ë³µ ì œê±° í›„ ì¶”ê°€
                  df = df[df['date'] != today_str]
                  df = pd.concat([df, pd.DataFrame([new_data])], ignore_index=True)
              else:
                  df = pd.DataFrame([new_data])
              
              df['date'] = pd.to_datetime(df['date'])
              df = df.sort_values('date')
              df.to_csv(CSV_FILE, index=False)
              print(f"Data saved: {today_str} - {mbytes} MB")
          else:
              # ìˆ˜ì§‘ ì‹¤íŒ¨í–ˆìœ¼ë©´ ê¸°ì¡´ íŒŒì¼ ì½ê¸°
              if os.path.exists(CSV_FILE):
                  df = pd.read_csv(CSV_FILE)
                  df['date'] = pd.to_datetime(df['date'])
              else:
                  print("No data available.")
                  exit(1)

          # --- 3. HTML ìƒì„± (ìë°”ìŠ¤í¬ë¦½íŠ¸ í¬í•¨) ---
          # ë°ì´í„°ë¥¼ JSON í˜•íƒœë¡œ ë³€í™˜í•˜ì—¬ HTML ë‚´ë¶€ì— ì‹¬ì–´ì¤Œ
          # ë‚ ì§œë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜
          df['date_str'] = df['date'].dt.strftime('%Y-%m-%d')
          # ìµœì‹  ë°ì´í„°ê°€ ìœ„ë¡œ ì˜¤ê²Œ ì •ë ¬ (í‘œ ë³´ê¸° í¸í•˜ê²Œ)
          df_desc = df.sort_values('date', ascending=False)
          
          # JSON ë°ì´í„° ì¤€ë¹„
          json_data = df_desc[['date_str', 'mbytes']].to_json(orient='records')
          
          update_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')

          html_content = f"""
          <!DOCTYPE html>
          <html lang="ko">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Lunamoth Traffic Dashboard</title>
              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
              <style>
                  body {{ font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; color: #333; background-color: #f9f9f9; }}
                  h1 {{ text-align: center; color: #2c3e50; }}
                  .card {{ background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }}
                  .controls {{ text-align: center; margin-bottom: 20px; }}
                  select {{ padding: 10px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; }}
                  .stat-box {{ text-align: center; font-size: 1.2em; font-weight: bold; color: #27ae60; margin: 10px 0; }}
                  table {{ width: 100%; border-collapse: collapse; margin-top: 10px; }}
                  th, td {{ padding: 12px; border-bottom: 1px solid #eee; text-align: center; }}
                  th {{ background-color: #f8f9fa; }}
                  tr:hover {{ background-color: #f1f1f1; }}
                  .footer {{ text-align: center; color: #888; font-size: 0.8em; margin-top: 30px; }}
              </style>
          </head>
          <body>
              <h1>ğŸ“Š íŠ¸ë˜í”½ ëŒ€ì‹œë³´ë“œ</h1>
              
              <div class="card controls">
                  <label for="monthSelect">ğŸ“… ì¡°íšŒ ì›” ì„ íƒ: </label>
                  <select id="monthSelect" onchange="updateDashboard()"></select>
              </div>

              <div class="card">
                  <div class="stat-box" id="avgTraffic">í‰ê·  íŠ¸ë˜í”½ ê³„ì‚° ì¤‘...</div>
                  <canvas id="trafficChart"></canvas>
              </div>

              <div class="card">
                  <h3>ğŸ“ ì¼ë³„ ìƒì„¸ ë‚´ì—­</h3>
                  <table id="trafficTable">
                      <thead>
                          <tr><th>ë‚ ì§œ</th><th>íŠ¸ë˜í”½ (MB)</th></tr>
                      </thead>
                      <tbody></tbody>
                  </table>
              </div>

              <div class="footer">Last Update: {update_time}</div>

              <script>
                  // íŒŒì´ì¬ì—ì„œ ì£¼ì…í•œ ì „ì²´ ë°ì´í„°
                  const rawData = {json_data};
                  let myChart = null;

                  function init() {{
                      const monthSelect = document.getElementById('monthSelect');
                      const months = new Set();
                      
                      // ë°ì´í„°ì—ì„œ 'YYYY-MM' í˜•ì‹ì˜ ì›” ëª©ë¡ ì¶”ì¶œ
                      rawData.forEach(row => {{
                          months.add(row.date_str.substring(0, 7));
                      }});

                      // ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
                      const sortedMonths = Array.from(months).sort().reverse();
                      sortedMonths.forEach(month => {{
                          const option = document.createElement('option');
                          option.value = month;
                          option.text = month;
                          monthSelect.appendChild(option);
                      }});

                      // ê¸°ë³¸ê°’: ê°€ì¥ ìµœê·¼ ì›”
                      if (sortedMonths.length > 0) {{
                          monthSelect.value = sortedMonths[0];
                          updateDashboard();
                      }}
                  }}

                  function updateDashboard() {{
                      const selectedMonth = document.getElementById('monthSelect').value;
                      const filteredData = rawData.filter(row => row.date_str.startsWith(selectedMonth));
                      
                      // ë‚ ì§œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ (ê·¸ë˜í”„ìš©)
                      const chartData = [...filteredData].sort((a, b) => a.date_str.localeCompare(b.date_str));

                      // 1. í‰ê·  ê³„ì‚°
                      let total = 0;
                      chartData.forEach(d => total += d.mbytes);
                      const avg = chartData.length ? (total / chartData.length).toFixed(2) : 0;
                      document.getElementById('avgTraffic').innerHTML = `ğŸ’¡ ${{selectedMonth}} ì¼í‰ê·  íŠ¸ë˜í”½: ${{avg}} MB`;

                      // 2. ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
                      const ctx = document.getElementById('trafficChart').getContext('2d');
                      if (myChart) myChart.destroy(); // ê¸°ì¡´ ì°¨íŠ¸ ì‚­ì œ

                      myChart = new Chart(ctx, {{
                          type: 'line',
                          data: {{
                              labels: chartData.map(d => d.date_str.substring(8, 10) + 'ì¼'), // ì¼ë§Œ í‘œì‹œ
                              datasets: [{{
                                  label: 'Traffic (MB)',
                                  data: chartData.map(d => d.mbytes),
                                  borderColor: '#3498db',
                                  backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                  borderWidth: 2,
                                  fill: true,
                                  tension: 0.1
                              }}]
                          }},
                          options: {{
                              responsive: true,
                              scales: {{
                                  y: {{ beginAtZero: true }}
                              }}
                          }}
                      }});

                      // 3. í‘œ ì±„ìš°ê¸° (ìµœì‹ ìˆœ)
                      const tbody = document.querySelector('#trafficTable tbody');
                      tbody.innerHTML = '';
                      // í‘œëŠ” ë‚´ë¦¼ì°¨ìˆœ(ìµœì‹  ë‚ ì§œ ìœ„ë¡œ)ì´ ë³´ê¸° ì¢‹ìœ¼ë¯€ë¡œ filteredData ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì´ë¯¸ ë‚´ë¦¼ì°¨ìˆœì„)
                      filteredData.forEach(row => {{
                          const tr = document.createElement('tr');
                          tr.innerHTML = `<td>${{row.date_str}}</td><td>${{row.mbytes}} MB</td>`;
                          tbody.appendChild(tr);
                      }});
                  }}

                  // ì‹¤í–‰
                  init();
              </script>
          </body>
          </html>
          """

          with open(HTML_FILE, "w", encoding="utf-8") as f:
              f.write(html_content)
          
          print("HTML generation complete.")

      - name: Commit and Push
        run: |
          git config --global user.name "TrafficBot"
          git config --global user.email "bot@noreply.github.com"
          git add traffic_data.csv index.html
          git commit -m "Update traffic dashboard: $(date +'%Y-%m-%d')" || exit 0
          git push
