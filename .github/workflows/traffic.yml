name: Traffic Monitor

on:
  schedule:
    # í•œêµ­ ì‹œê°„ ë§¤ì¼ ì˜¤í›„ 11ì‹œ 59ë¶„ (UTC 14:59) ì‹¤í–‰
    - cron: '59 14 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ í™œì„±í™”

permissions:
  contents: write

jobs:
  update-traffic:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests beautifulsoup4 pandas matplotlib

      - name: Run Traffic Script
        shell: python
        run: |
          import requests
          from bs4 import BeautifulSoup
          import pandas as pd
          import matplotlib.pyplot as plt
          import base64
          from io import BytesIO
          from datetime import datetime
          import os

          # --- 1. ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ---
          URL = "http://lunamoth.com/throttle-me"
          CSV_FILE = "traffic_data.csv"
          HTML_FILE = "index.html"
          
          try:
              print(f"Connecting to {URL}...")
              response = requests.get(URL, timeout=30)
              response.raise_for_status()
              soup = BeautifulSoup(response.text, 'html.parser')
              
              # lunamoth.biz í–‰ ì°¾ì•„ì„œ ë°ì´í„° ë½‘ê¸°
              rows = soup.find_all('tr')
              kbytes = 0
              found = False
              
              for row in rows:
                  if "lunamoth.biz" in row.text:
                      cols = [ele.text.strip() for ele in row.find_all(['td', 'th'])]
                      # ë°ì´í„° ìˆœì„œìƒ 6ë²ˆì§¸(ì¸ë±ìŠ¤ 5)ê°€ KBytes sent
                      if len(cols) > 5:
                          kbytes = int(cols[5])
                          found = True
                          break
              
              if not found:
                  print("Error: Could not find traffic data in HTML.")
                  exit(1)

          except Exception as e:
              print(f"Error fetching data: {e}")
              exit(1)

          # --- 2. ë°ì´í„° ì €ì¥ (CSV) ---
          now = datetime.now()
          today_str = now.strftime("%Y-%m-%d")
          mbytes = round(kbytes / 1024, 2) # MB ë‹¨ìœ„ ë³€í™˜

          new_data = {'date': today_str, 'kbytes': kbytes, 'mbytes': mbytes}
          
          if os.path.exists(CSV_FILE):
              df = pd.read_csv(CSV_FILE)
              # ì˜¤ëŠ˜ ë‚ ì§œ ë°ì´í„°ê°€ ì´ë¯¸ ìˆìœ¼ë©´ ë®ì–´ì“°ê¸° ìœ„í•´ ì‚­ì œ í›„ ì¶”ê°€
              df = df[df['date'] != today_str]
              df = pd.concat([df, pd.DataFrame([new_data])], ignore_index=True)
          else:
              df = pd.DataFrame([new_data])
          
          df['date'] = pd.to_datetime(df['date'])
          df = df.sort_values('date')
          df.to_csv(CSV_FILE, index=False)
          print(f"Data saved: {today_str} - {mbytes} MB")

          # --- 3. ê·¸ë˜í”„ ê·¸ë¦¬ê¸° (ì´ë¯¸ì§€ íŒŒì¼ ìƒì„± ì•ˆ í•˜ê³  HTMLì— ë°”ë¡œ ë„£ê¸°) ---
          plt.figure(figsize=(10, 5))
          plt.plot(df['date'], df['mbytes'], marker='o', linestyle='-', color='#4CAF50')
          plt.title('Daily Traffic (MB)')
          plt.xlabel('Date')
          plt.ylabel('MB')
          plt.grid(True, linestyle='--', alpha=0.7)
          plt.gcf().autofmt_xdate()
          
          img_buffer = BytesIO()
          plt.savefig(img_buffer, format='png')
          img_buffer.seek(0)
          img_base64 = base64.b64encode(img_buffer.read()).decode('utf-8')
          plt.close()

          # --- 4. í†µê³„ ê³„ì‚° (ì›”ë³„) ---
          df['ym'] = df['date'].dt.strftime('%Yë…„ %mì›”')
          monthly = df.groupby('ym')['mbytes'].mean().round(2).reset_index().sort_values('ym', ascending=False)

          # --- 5. HTML ë¦¬í¬íŠ¸ ìƒì„± ---
          html = f"""
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="utf-8">
              <title>Lunamoth Traffic Report</title>
              <style>
                  body {{ font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; color: #333; }}
                  h1 {{ border-bottom: 2px solid #eee; padding-bottom: 10px; }}
                  table {{ width: 100%; border-collapse: collapse; margin: 20px 0; }}
                  th, td {{ border: 1px solid #ddd; padding: 10px; text-align: center; }}
                  th {{ background-color: #f8f9fa; }}
                  .graph {{ text-align: center; margin: 30px 0; border: 1px solid #eee; padding: 10px; border-radius: 8px; }}
                  img {{ max-width: 100%; height: auto; }}
              </style>
          </head>
          <body>
              <h1>ğŸ“Š ì¼ì¼ íŠ¸ë˜í”½ ë¦¬í¬íŠ¸</h1>
              <p>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {now.strftime('%Y-%m-%d %H:%M:%S')} (UTC)</p>

              <div class="graph">
                  <img src="data:image/png;base64,{img_base64}" alt="Traffic Graph">
              </div>

              <h3>ğŸ“… ì›”ë³„ í‰ê·  íŠ¸ë˜í”½</h3>
              <table>
                  <tr><th>ì—°ë„-ì›”</th><th>í‰ê·  íŠ¸ë˜í”½ (MB)</th></tr>
                  {''.join(f"<tr><td>{r['ym']}</td><td>{r['mbytes']} MB</td></tr>" for _, r in monthly.iterrows())}
              </table>

              <h3>ğŸ“ ìµœê·¼ ì¼ë³„ ê¸°ë¡ (7ì¼)</h3>
              <table>
                  <tr><th>ë‚ ì§œ</th><th>íŠ¸ë˜í”½ (MB)</th></tr>
                  {''.join(f"<tr><td>{r['date'].strftime('%Y-%m-%d')}</td><td>{r['mbytes']} MB</td></tr>" for _, r in df.sort_values('date', ascending=False).head(7).iterrows())}
              </table>
          </body>
          </html>
          """

          with open(HTML_FILE, "w", encoding="utf-8") as f:
              f.write(html)

      - name: Commit and Push
        run: |
          git config --global user.name "TrafficBot"
          git config --global user.email "bot@noreply.github.com"
          git add traffic_data.csv index.html
          git commit -m "Update traffic: $(date +'%Y-%m-%d')" || exit 0
          git push
