name: Traffic Monitor

on:
  schedule:
    - cron: '40 14 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-traffic:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests beautifulsoup4 pandas

      - name: Run Traffic Script
        shell: python
        run: |
          import requests
          from bs4 import BeautifulSoup
          import pandas as pd
          from datetime import datetime
          import os
          import json

          # --- ì„¤ì • ---
          URL = "http://lunamoth.com/throttle-me"
          CSV_FILE = "traffic_data.csv"
          HTML_FILE = "index.html"
          
          # ë´‡ ì°¨ë‹¨ ë°©ì§€ìš© í—¤ë”
          headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'}

          # 1. ë°ì´í„° ìˆ˜ì§‘
          try:
              print(f"Connecting to {URL}...")
              response = requests.get(URL, headers=headers, timeout=30)
              soup = BeautifulSoup(response.text, 'html.parser')
              
              kbytes = 0
              found = False
              
              rows = soup.find_all('tr')
              for row in rows:
                  if "lunamoth.biz" in row.text:
                      cols = [ele.text.strip() for ele in row.find_all(['td', 'th'])]
                      if len(cols) > 5:
                          kbytes = int(cols[5])
                          found = True
                          break
              
              if found:
                  # CSV ì €ì¥
                  now = datetime.now()
                  today_str = now.strftime("%Y-%m-%d")
                  mbytes = round(kbytes / 1024, 2)
                  
                  new_data = {'date': today_str, 'kbytes': kbytes, 'mbytes': mbytes}
                  
                  if os.path.exists(CSV_FILE):
                      df = pd.read_csv(CSV_FILE)
                      df = df[df['date'] != today_str]
                      df = pd.concat([df, pd.DataFrame([new_data])], ignore_index=True)
                  else:
                      df = pd.DataFrame([new_data])
                  
                  df['date'] = pd.to_datetime(df['date'])
                  df = df.sort_values('date')
                  df.to_csv(CSV_FILE, index=False)
                  print("CSV Saved.")
              else:
                  print("Data not found in HTML.")

          except Exception as e:
              print(f"Error: {e}")
              pass

          # 2. HTML ìƒì„± (Safe Method)
          # ë°ì´í„° ì¤€ë¹„
          json_str = "[]"
          if os.path.exists(CSV_FILE):
              df = pd.read_csv(CSV_FILE)
              df['date'] = pd.to_datetime(df['date'])
              df['date_str'] = df['date'].dt.strftime('%Y-%m-%d')
              df_desc = df.sort_values('date', ascending=False)
              json_str = df_desc[['date_str', 'mbytes']].to_json(orient='records')

          update_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')

          # HTML í…œí”Œë¦¿ (Python f-stringì„ ì“°ì§€ ì•Šê³  replaceë¥¼ ì‚¬ìš©í•˜ì—¬ ì¶©ëŒ ë°©ì§€)
          html_template = """
          <!DOCTYPE html>
          <html lang="ko">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Lunamoth Traffic Dashboard</title>
              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
              <style>
                  body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f7f6; color: #333; }
                  .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
                  h1 { text-align: center; }
                  .control-box { text-align: center; background: #e8f0fe; padding: 15px; border-radius: 8px; border: 1px solid #d2e3fc; }
                  select { padding: 8px 15px; font-size: 16px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; }
                  .stat { text-align: center; font-size: 1.1em; font-weight: bold; color: #2e7d32; margin: 15px 0; }
                  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                  th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
                  th { background-color: #f8f9fa; }
              </style>
          </head>
          <body>
              <h1>ğŸ“Š íŠ¸ë˜í”½ ëŒ€ì‹œë³´ë“œ</h1>
              
              <div class="card control-box">
                  <label for="monthSelect">ğŸ“… <b>ì¡°íšŒí•  ì›”ì„ ì„ íƒí•˜ì„¸ìš”:</b> </label>
                  <select id="monthSelect" onchange="updateDashboard()">
                      <option value="">ë°ì´í„° ë¡œë”© ì¤‘...</option>
                  </select>
              </div>

              <div class="card">
                  <div class="stat" id="avgText">-</div>

                  <!-- ì¶”ê°€ëœ ìš”ì•½ í…Œì´ë¸” (ìˆœì„œ: ìµœê³  -> í‰ê·  -> ìµœì €) -->
                  <table style="margin-bottom: 20px; border: 1px solid #eee;">
                      <thead>
                          <tr style="background-color: #f1f3f4;">
                              <th>êµ¬ë¶„</th>
                              <th>ì¼ì</th>
                              <th>íŠ¸ë˜í”½ (MB)</th>
                          </tr>
                      </thead>
                      <tbody>
                          <tr>
                              <td style="color: red;">ğŸ“ˆ ìµœê³ </td>
                              <td id="maxDate">-</td>
                              <td id="maxVal">-</td>
                          </tr>
                          <tr>
                              <td style="font-weight: bold;">ğŸ’¡ í‰ê· </td>
                              <td>-</td>
                              <td id="avgValTable">-</td>
                          </tr>
                          <tr>
                              <td style="color: blue;">ğŸ“‰ ìµœì €</td>
                              <td id="minDate">-</td>
                              <td id="minVal">-</td>
                          </tr>
                      </tbody>
                  </table>
                  <!-- ì¶”ê°€ëœ ìš”ì•½ í…Œì´ë¸” ë -->

                  <canvas id="trafficChart"></canvas>
              </div>

              <div class="card">
                  <h3>ğŸ“ ìƒì„¸ ë‚´ì—­</h3>
                  <table id="trafficTable">
                      <thead><tr><th>ë‚ ì§œ</th><th>íŠ¸ë˜í”½ (MB)</th></tr></thead>
                      <tbody></tbody>
                  </table>
              </div>
              
              <div style="text-align:center; color:#999; font-size:12px;">Last Update: __UPDATE_TIME__</div>

              <script>
                  const rawData = __JSON_DATA__; 
                  let myChart = null;

                  function init() {
                      const select = document.getElementById('monthSelect');
                      
                      if (!rawData || rawData.length === 0) {
                          select.innerHTML = '<option>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</option>';
                          return;
                      }

                      const months = new Set();
                      rawData.forEach(d => months.add(d.date_str.substring(0, 7)));
                      const sortedMonths = Array.from(months).sort().reverse();

                      select.innerHTML = '';
                      sortedMonths.forEach(m => {
                          const opt = document.createElement('option');
                          opt.value = m;
                          opt.text = m;
                          select.appendChild(opt);
                      });

                      if (sortedMonths.length > 0) {
                          select.value = sortedMonths[0];
                          updateDashboard();
                      }
                  }

                  function updateDashboard() {
                      const month = document.getElementById('monthSelect').value;
                      const data = rawData.filter(d => d.date_str.startsWith(month));
                      const chartData = [...data].sort((a,b) => a.date_str.localeCompare(b.date_str));

                      let sum = 0;
                      chartData.forEach(d => sum += d.mbytes);
                      const avg = chartData.length ? (sum / chartData.length).toFixed(2) : 0;
                      
                      // ìë°”ìŠ¤í¬ë¦½íŠ¸ í…œí”Œë¦¿ ë¦¬í„°ëŸ´ ì‚¬ìš© (ì•ˆì „í•¨)
                      document.getElementById('avgText').innerText = `ğŸ’¡ ${month} ì¼í‰ê· : ${avg} MB`;
                      
                      // --- ì¶”ê°€ëœ ë¡œì§: ìµœì €/ìµœê³ /í‰ê·  ë³„ë„ í‘œê¸° ---
                      if (chartData.length > 0) {
                          // ìµœì €ê°’ ì°¾ê¸°
                          const minRow = chartData.reduce((prev, curr) => prev.mbytes < curr.mbytes ? prev : curr);
                          // ìµœê³ ê°’ ì°¾ê¸°
                          const maxRow = chartData.reduce((prev, curr) => prev.mbytes > curr.mbytes ? prev : curr);

                          document.getElementById('minDate').innerText = minRow.date_str;
                          document.getElementById('minVal').innerText = minRow.mbytes;
                          
                          document.getElementById('maxDate').innerText = maxRow.date_str;
                          document.getElementById('maxVal').innerText = maxRow.mbytes;

                          document.getElementById('avgValTable').innerText = avg;
                      } else {
                          document.getElementById('minDate').innerText = "-";
                          document.getElementById('minVal').innerText = "-";
                          document.getElementById('maxDate').innerText = "-";
                          document.getElementById('maxVal').innerText = "-";
                          document.getElementById('avgValTable').innerText = "-";
                      }
                      // --- ì¶”ê°€ëœ ë¡œì§ ë ---

                      const tbody = document.querySelector('#trafficTable tbody');
                      tbody.innerHTML = '';
                      data.forEach(row => {
                          const tr = document.createElement('tr');
                          tr.innerHTML = `<td>${row.date_str}</td><td>${row.mbytes} MB</td>`;
                          tbody.appendChild(tr);
                      });

                      const ctx = document.getElementById('trafficChart').getContext('2d');
                      if (myChart) myChart.destroy();

                      myChart = new Chart(ctx, {
                          type: 'line',
                          data: {
                              labels: chartData.map(d => d.date_str.slice(8,10) + 'ì¼'),
                              datasets: [{
                                  label: 'ì‚¬ìš©ëŸ‰ (MB)',
                                  data: chartData.map(d => d.mbytes),
                                  borderColor: '#2196F3',
                                  backgroundColor: 'rgba(33, 150, 243, 0.1)',
                                  fill: true,
                                  tension: 0.2
                              }]
                          },
                          options: { responsive: true }
                      });
                  }

                  init();
              </script>
          </body>
          </html>
          """

          # í…ìŠ¤íŠ¸ ì¹˜í™˜ ë°©ì‹ìœ¼ë¡œ ë°ì´í„° ì£¼ì… (ê°€ì¥ ì•ˆì „í•œ ë°©ë²•)
          final_html = html_template.replace("__JSON_DATA__", json_str)
          final_html = final_html.replace("__UPDATE_TIME__", update_time)

          with open(HTML_FILE, "w", encoding="utf-8") as f:
              f.write(final_html)

      - name: Commit and Push
        run: |
          git config --global user.name "TrafficBot"
          git config --global user.email "bot@noreply.github.com"
          git add traffic_data.csv index.html
          git commit -m "Update Dashboard" || exit 0
          git push
