name: Traffic Monitor

on:
  schedule:
    - cron: '59 14 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-traffic:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests beautifulsoup4 pandas

      - name: Run Traffic Script
        shell: python
        run: |
          import requests
          from bs4 import BeautifulSoup
          import pandas as pd
          from datetime import datetime
          import os
          import json

          # --- ì„¤ì • ---
          URL = "http://lunamoth.com/throttle-me"
          CSV_FILE = "traffic_data.csv"
          HTML_FILE = "index.html"
          
          # ë´‡ ì°¨ë‹¨ ë°©ì§€ìš© í—¤ë”
          headers = {'User-Agent': 'Mozilla/5.0'}

          # 1. ë°ì´í„° ìˆ˜ì§‘
          try:
              print(f"Connecting to {URL}...")
              response = requests.get(URL, headers=headers, timeout=30)
              soup = BeautifulSoup(response.text, 'html.parser')
              
              kbytes = 0
              found = False
              
              rows = soup.find_all('tr')
              for row in rows:
                  if "lunamoth.biz" in row.text:
                      cols = [ele.text.strip() for ele in row.find_all(['td', 'th'])]
                      # 6ë²ˆì§¸ ë°ì´í„° (ì¸ë±ìŠ¤ 5)
                      if len(cols) > 5:
                          kbytes = int(cols[5])
                          found = True
                          break
              
              if found:
                  # CSV ì €ì¥
                  now = datetime.now()
                  today_str = now.strftime("%Y-%m-%d")
                  mbytes = round(kbytes / 1024, 2)
                  
                  new_data = {'date': today_str, 'kbytes': kbytes, 'mbytes': mbytes}
                  
                  if os.path.exists(CSV_FILE):
                      df = pd.read_csv(CSV_FILE)
                      df = df[df['date'] != today_str] # ì¤‘ë³µ ì œê±°
                      df = pd.concat([df, pd.DataFrame([new_data])], ignore_index=True)
                  else:
                      df = pd.DataFrame([new_data])
                  
                  df['date'] = pd.to_datetime(df['date'])
                  df = df.sort_values('date')
                  df.to_csv(CSV_FILE, index=False)
                  print("CSV Saved.")

          except Exception as e:
              print(f"Error: {e}")
              pass

          # 2. HTML ìƒì„± (ë°ì´í„°ê°€ ì—†ì–´ë„ ë¹ˆ ê»ë°ê¸°ëŠ” ìƒì„±í•˜ë„ë¡ ìˆ˜ì •)
          if os.path.exists(CSV_FILE):
              df = pd.read_csv(CSV_FILE)
              df['date'] = pd.to_datetime(df['date'])
              df['date_str'] = df['date'].dt.strftime('%Y-%m-%d')
              df_desc = df.sort_values('date', ascending=False)
              json_data = df_desc[['date_str', 'mbytes']].to_json(orient='records')
          else:
              json_data = "[]" # ë°ì´í„° ì—†ìŒ

          update_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')

          html_content = f"""
          <!DOCTYPE html>
          <html lang="ko">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Lunamoth Traffic Dashboard</title>
              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
              <style>
                  body {{ font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f7f6; }}
                  .card {{ background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }}
                  h1 {{ text-align: center; color: #333; }}
                  
                  /* ì„ íƒê¸° ìŠ¤íƒ€ì¼ ê°•ì¡° */
                  .control-box {{ text-align: center; background: #e8f0fe; padding: 15px; border-radius: 8px; border: 1px solid #d2e3fc; }}
                  select {{ padding: 8px 15px; font-size: 16px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; }}
                  
                  .stat {{ text-align: center; font-size: 1.1em; font-weight: bold; color: #2e7d32; margin: 15px 0; }}
                  table {{ width: 100%; border-collapse: collapse; margin-top: 10px; }}
                  th, td {{ padding: 10px; border-bottom: 1px solid #eee; text-align: center; }}
                  th {{ background-color: #f8f9fa; }}
              </style>
          </head>
          <body>
              <h1>ğŸ“Š íŠ¸ë˜í”½ ëŒ€ì‹œë³´ë“œ</h1>
              
              <!-- ì›” ì„ íƒê¸° ì˜ì—­ -->
              <div class="card control-box">
                  <label for="monthSelect">ğŸ“… <b>ì¡°íšŒí•  ì›”ì„ ì„ íƒí•˜ì„¸ìš”:</b> </label>
                  <select id="monthSelect" onchange="updateDashboard()">
                      <option value="">ë°ì´í„° ë¡œë”© ì¤‘...</option>
                  </select>
              </div>

              <!-- ê·¸ë˜í”„ ì˜ì—­ -->
              <div class="card">
                  <div class="stat" id="avgText">-</div>
                  <canvas id="trafficChart"></canvas>
              </div>

              <!-- í‘œ ì˜ì—­ -->
              <div class="card">
                  <h3>ğŸ“ ìƒì„¸ ë‚´ì—­</h3>
                  <table id="trafficTable">
                      <thead><tr><th>ë‚ ì§œ</th><th>íŠ¸ë˜í”½ (MB)</th></tr></thead>
                      <tbody></tbody>
                  </table>
              </div>
              
              <div style="text-align:center; color:#999; font-size:12px;">Last Update: {update_time}</div>

              <script>
                  const rawData = {json_data}; // íŒŒì´ì¬ ë°ì´í„° ì£¼ì…
                  let myChart = null;

                  function init() {{
                      const select = document.getElementById('monthSelect');
                      
                      // 1. ë°ì´í„°ê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
                      if (!rawData || rawData.length === 0) {{
                          select.innerHTML = '<option>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</option>';
                          return;
                      }}

                      // 2. ì›” ëª©ë¡ ì¶”ì¶œ (ì¤‘ë³µì œê±°)
                      const months = new Set();
                      rawData.forEach(d => months.add(d.date_str.substring(0, 7)));
                      const sortedMonths = Array.from(months).sort().reverse();

                      // 3. ì„ íƒê¸° ì±„ìš°ê¸°
                      select.innerHTML = ''; // ë¡œë”©ì¤‘ ë©”ì‹œì§€ ì‚­ì œ
                      sortedMonths.forEach(m => {{
                          const opt = document.createElement('option');
                          opt.value = m;
                          opt.text = m;
                          select.appendChild(opt);
                      }});

                      // 4. ì²«ë²ˆì§¸ ì›” ìë™ ì„ íƒ
                      if (sortedMonths.length > 0) {{
                          select.value = sortedMonths[0];
                          updateDashboard();
                      }}
                  }}

                  function updateDashboard() {{
                      const month = document.getElementById('monthSelect').value;
                      // í•´ë‹¹ ì›” ë°ì´í„°ë§Œ í•„í„°ë§
                      const data = rawData.filter(d => d.date_str.startsWith(month));
                      // ê·¸ë˜í”„ìš©ì€ ë‚ ì§œ ì˜¤ë¦„ì°¨ìˆœ (1ì¼ -> 31ì¼)
                      const chartData = [...data].sort((a,b) => a.date_str.localeCompare(b.date_str));

                      // í†µê³„ ê³„ì‚°
                      let sum = 0;
                      chartData.forEach(d => sum += d.mbytes);
                      const avg = (sum / chartData.length).toFixed(2);
                      document.getElementById('avgText').innerText = `ğŸ’¡ ${{month}} ì¼í‰ê· : ${{avg}} MB`;

                      // í‘œ ì±„ìš°ê¸° (ìµœì‹ ìˆœ)
                      const tbody = document.querySelector('#trafficTable tbody');
                      tbody.innerHTML = '';
                      data.forEach(row => {{
                          const tr = document.createElement('tr');
                          tr.innerHTML = `<td>${{row.date_str}}</td><td>${{row.mbytes}} MB</td>`;
                          tbody.appendChild(tr);
                      }});

                      // ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
                      const ctx = document.getElementById('trafficChart').getContext('2d');
                      if (myChart) myChart.destroy();

                      myChart = new Chart(ctx, {{
                          type: 'line',
                          data: {{
                              labels: chartData.map(d => d.date_str.slice(8,10) + 'ì¼'),
                              datasets: [{{
                                  label: 'ì‚¬ìš©ëŸ‰ (MB)',
                                  data: chartData.map(d => d.mbytes),
                                  borderColor: '#2196F3',
                                  backgroundColor: 'rgba(33, 150, 243, 0.1)',
                                  fill: true,
                                  tension: 0.2
                              }}]
                          }},
                          options: {{ responsive: true }}
                      }});
                  }}

                  // ì‹œì‘
                  init();
              </script>
          </body>
          </html>
          """

          with open(HTML_FILE, "w", encoding="utf-8") as f:
              f.write(html_content)

      - name: Commit and Push
        run: |
          git config --global user.name "TrafficBot"
          git config --global user.email "bot@noreply.github.com"
          git add traffic_data.csv index.html
          git commit -m "Update Dashboard" || exit 0
          git push
